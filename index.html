<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EGREGOR SCHOOL</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- imask.js for phone number masking -->
    <script src="https://unpkg.com/imask"></script>
    <!-- intl-tel-input for country code selection -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/css/intlTelInput.css"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/js/intlTelInput.min.js"></script>
    <style>
        /* Importing fonts: Montserrat for headings and Open Sans for text */
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@700&family=Open+Sans:wght@400;600&display=swap');
        body {
            font-family: 'Open Sans', sans-serif; /* Main font */
            background-color: #121212; /* Deep dark background */
            color: #e5e7eb; /* Light default text */
            scroll-behavior: smooth;
        }
        .font-heading {
            font-family: 'Montserrat', sans-serif;
        }
        /* Container for responsive video */
        .video-container {
            position: relative;
            width: 100%;
            padding-top: 56.25%; /* 16:9 aspect ratio */
        }
        .video-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        
        /* Bulletproof list styling with pseudo-elements */
        .styled-list {
            list-style: none;
            padding-left: 0;
        }
        .styled-list li {
            position: relative;
            padding-left: 28px; /* Space for the bullet + gap */
        }
        .styled-list li::before {
            content: '';
            position: absolute;
            left: 0;
            top: 6px; /* Fine-tuned for vertical alignment */
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: linear-gradient(to bottom right, #5FEAFF, #4C87FF);
            box-shadow: 0 0 10px 2px rgba(95, 234, 255, 0.4);
        }

        /* Shimmer animation for the progress bar */
        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }
        .progress-bar-animated {
            background: linear-gradient(to right, #4C87FF, #5FEAFF, #4C87FF);
            background-size: 200% 100%;
            animation: shimmer 6s infinite linear;
            box-shadow: 0 0 10px rgba(95, 234, 255, 0.4);
        }

        /* Text shadow for buttons */
        .text-shadow {
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.4);
        }

        /* Lead Form Styles */
        .form-step {
            display: none;
            animation: fadeIn 0.5s;
        }
        .form-step.active {
            display: block;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* Styles for intl-tel-input */
        .iti { width: 100%; }
        .iti__country-list { background-color: #2d2d2d; border-color: #444; }
        .iti__country { color: #e5e7eb; }
        .iti__country:hover { background-color: #444; }
        .iti__dial-code { color: #888; }
    </style>
    <!-- Telegram Web Apps API -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body class="p-2 sm:p-4 md:p-8">

    <!-- Main application container -->
    <div id="app-container" class="max-w-md lg:max-w-4xl mx-auto">
        <div class="bg-neutral-900 p-6 rounded-3xl shadow-2xl border border-gray-800">
            <h1 class="text-3xl lg:text-4xl font-bold text-center mb-6 font-heading bg-clip-text text-transparent bg-gradient-to-br from-[#5FEAFF] to-[#4C87FF]">EGREGOR SCHOOL</h1>

            <div class="relative w-full h-2 rounded-full bg-gray-700 mb-6 overflow-hidden">
                <div id="progress-bar" class="h-2 rounded-full transition-all duration-500 ease-in-out" style="width: 0%;"></div>
            </div>
            
            <div id="lesson-container" class="bg-neutral-800 rounded-3xl shadow-lg p-6 mb-6">
                <h2 id="lesson-title" class="text-2xl lg:text-3xl font-bold text-gray-100 mb-6 font-heading"></h2>
                
                <div id="lesson-video-container" class="rounded-2xl mb-4 overflow-hidden shadow-lg"></div>

                <div id="lesson-content-container" class="text-gray-300 text-base lg:text-lg leading-relaxed mt-8"></div>

                <div id="nav-buttons-container-main" class="mt-8"></div>
                
                <div id="homework-block" class="mt-8 p-6 bg-neutral-900/50 rounded-2xl border border-gray-700 space-y-4 hidden">
                    <h3 class="text-xl font-bold text-gray-100 font-heading text-center">Твое Домашнее Задание</h3>
                    <p class="text-gray-300 text-sm text-center">Ты&nbsp;уже знаешь про 4&nbsp;направления, поэтому сейчас нужно:</p>
                    <div class="border-t border-b border-gray-700 py-4">
                        <ul id="homework-list" class="styled-list space-y-4"></ul>
                    </div>
                    <p class="text-gray-300 text-sm">Главное тут не&nbsp;стесняться, писать, как получается. Сразу после выполнения ДЗ&nbsp;мы&nbsp;свяжемся с&nbsp;тобой и&nbsp;поможем с&nbsp;каждым вопросом.</p>
                    <div class="flex justify-center">
                        <a href="https://t.me/m/ruJF1WznM2Qy" target="_blank" class="text-center block bg-gradient-to-br from-[#5FEAFF] to-[#4C87FF] text-white font-semibold py-3 px-8 rounded-full shadow-xl transition-all duration-300 hover:scale-105 w-full text-shadow">Сдать домашку</a>
                    </div>
                </div>
                
                <div id="lesson-3-extra-content" class="hidden space-y-6 mt-8">
                    <div class="space-y-6">
                        <div class="bg-neutral-900/50 rounded-2xl shadow-lg p-6 border border-gray-700/50">
                            <h3 class="font-heading text-xl text-white mb-2">Что такое личный разбор?</h3>
                            <p class="text-gray-400 mb-6 text-sm">Разборы&nbsp;— это мое искусство. В&nbsp;общей сложности я&nbsp;потратил на&nbsp;это >10&nbsp;000 часов</p>
                            <ul class="styled-list space-y-4">
                                <li>Это единственный вариант поработать со&nbsp;мной и&nbsp;моей командой бесплатно</li>
                                <li>Это отдельный продукт, цель которого&nbsp;— открыть тебе глаза на&nbsp;то, как конкретно ты&nbsp;сможешь зарабатывать на&nbsp;маркетинге, и&nbsp;что для этого нужно сделать</li>
                                <li>Формат работы: <span class="font-semibold text-white">бесплатный онлайн-созвон на&nbsp;40-60 минут по&nbsp;ZOOM</span></li>
                            </ul>
                        </div>
                        <div class="bg-neutral-900/50 rounded-2xl shadow-lg p-6 border border-gray-700/50">
                            <h3 class="font-heading text-xl text-white mb-6">Что ты&nbsp;получишь?</h3>
                             <ul class="styled-list space-y-4">
                                <li>Поможем выбрать одно из&nbsp;4-х направлений. Разберем, как тебе быстро изучить одно из&nbsp;них и&nbsp;построим готовый план действий</li>
                                <li>Покажем, с&nbsp;кем работать, что писать, какие первые шаги сделать, чтобы&nbsp;быстро найти клиентов и&nbsp;получить деньги на&nbsp;услугах</li>
                                <li>Расскажем про все подводные камни, погрузим тебя в&nbsp;основы маркетинга и&nbsp;работу с&nbsp;клиентами.</li>
                                <li>Дадим взгляд со&nbsp;стороны. Раскроем на&nbsp;примере реальных кейсов то, как с&nbsp;нуля за&nbsp;1-2 месяца выйти на&nbsp;стабильные 100.000 рублей на&nbsp;маркетинге.</li>
                                <li>Погрузим во&nbsp;внутрянку моих проектов, покажем, как внутри них строится работа.</li>
                            </ul>
                        </div>
                    </div>
                    <div class="pt-4">
                         <button class="analytics-cta w-full bg-gradient-to-br from-[#5FEAFF] to-[#4C87FF] text-white font-semibold py-4 px-6 rounded-full shadow-xl transition-all duration-300 hover:scale-105 flex items-center justify-center text-shadow text-lg">
                            <span>Попасть на&nbsp;разборы</span>
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ml-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" /></svg>
                        </button>
                        <p class="text-center text-xs text-gray-500 mt-4">
                            Нажимая на&nbsp;кнопку «Попасть на разборы» вы&nbsp;соглашаетесь с&nbsp;<a href="https://www.gregedu.ru/polkon" target="_blank" class="underline hover:text-gray-300 transition-colors">Политикой конфиденциальности</a>&nbsp;и&nbsp;даёте&nbsp;<a href="https://www.gregedu.ru/soglasie" target="_blank" class="underline hover:text-gray-300 transition-colors">согласие на&nbsp;обработку персональных данных</a>.
                        </p>
                    </div>
                </div>

                <div id="nav-buttons-container-secondary" class="mt-8"></div>
            </div>

            <div id="question-placeholder" class="mb-6"></div>

            <a id="footer-tg-link" href="https://t.me/+CpRx-dZO-59iNjcy" target="_blank" class="block mt-6">
                <div class="bg-gradient-to-br from-[#5FEAFF] to-[#4C87FF] p-6 rounded-3xl shadow-lg border border-sky-800 flex items-center justify-center space-x-4 transition-all duration-300 hover:scale-[1.02] hover:shadow-2xl cursor-pointer">
                    <div class="flex-shrink-0">
                        <img src="png-klev-club-fqtr-p-samoletik-telegramma-png-5.png" alt="Telegram" class="w-12 h-12">
                    </div>
                    <div class="text-left">
                        <h3 class="text-xl font-bold text-white mb-1 font-heading text-shadow">Telegram-канал EGREGOR</h3>
                        <p class="text-gray-200 text-sm text-shadow">В&nbsp;нем еще больше про маркетинг и&nbsp;заработок</p>
                    </div>
                </div>
            </a>
        </div>
        
        <footer class="mt-8 pt-8 border-t border-neutral-800 text-center text-xs text-neutral-500 space-y-4">
            <div>
                <p class="font-semibold text-neutral-400">ГРИГОРИЙ ШИЛОВ</p>
                <p>ИП ШИЛОВ ГРИГОРИЙ ЕВГЕНЬЕВИЧ</p>
            </div>
            <div>
                <p>ИНН: 291800299680</p>
                <p>ОГРН: 321290100034280</p>
            </div>
            <div class="flex flex-col sm:flex-row items-center justify-center gap-x-4 gap-y-2">
                <a href="mailto:shilov.greg@gmail.com" class="hover:text-neutral-300 transition-colors">shilov.greg@gmail.com</a>
                <span class="hidden sm:inline">·</span>
                <a href="https://t.me/shilovgreg" target="_blank" class="hover:text-neutral-300 transition-colors">Задать вопрос в TG: @shilovgreg</a>
            </div>
            <div class="flex flex-col sm:flex-row justify-center items-center gap-x-4 gap-y-2 pt-2">
                <a href="https://www.gregedu.ru/polkon" target="_blank" class="hover:text-neutral-300 transition-colors">Политика конфиденциальности</a>
                <span class="hidden sm:inline text-neutral-600">|</span>
                <a href="https://www.gregedu.ru/soglasie" target="_blank" class="hover:text-neutral-300 transition-colors">Согласие на обработку ПД</a>
                <span class="hidden sm:inline text-neutral-600">|</span>
                <a href="https://www.gregedu.ru/offerta" target="_blank" class="hover:text-neutral-300 transition-colors">Оферта</a>
            </div>
        </footer>
    </div>

    <!-- Lead Form Modal -->
    <div id="lead-form-modal" class="fixed inset-0 bg-black bg-opacity-80 hidden flex items-center justify-center p-4 z-50">
        <div id="lead-form-content" class="bg-neutral-900 rounded-3xl shadow-2xl border border-gray-800 w-full max-w-md transform transition-all duration-300 scale-95 opacity-0">
            <div class="p-6 relative">
                <button id="close-form-button" class="absolute top-4 right-4 text-gray-500 hover:text-white transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
                <div id="lead-form-progress" class="w-full h-2 rounded-full bg-gray-700 mb-6">
                    <div id="lead-form-progress-bar" class="h-2 rounded-full bg-gradient-to-r from-[#5FEAFF] to-[#4C87FF] transition-all duration-300" style="width: 0%;"></div>
                </div>

                <form id="lead-form">
                    <!-- Steps will be injected here by JS -->
                </form>

                <div id="form-thank-you" class="hidden text-center py-12">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 text-green-400 mx-auto mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                    <h3 class="text-2xl font-bold text-white mb-2">Спасибо!</h3>
                    <p class="text-gray-400">Ваша заявка отправлена. Мы&nbsp;скоро с&nbsp;вами свяжемся.</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            Telegram.WebApp.ready();

            const SHEETY_URL = "https://api.sheety.co/b61f74d84dc46b147f3a02c9828b143f/egregor/leads";
            const SHEETY_AUTH = "Basic ZWdyZWdvcjplZ3JlZ29yXzI=";

            let tgUserId = 'unknown_user';
            try {
                tgUserId = Telegram.WebApp?.initDataUnsafe?.user?.id || ('test_user_' + Math.random().toString(36).slice(2));
            } catch (e) {
                console.warn("Could not get Telegram User ID.", e);
            }

            const submitFormData = (formDataObject) => {
                const now = new Date();
                const payload = {
                    name: formDataObject.name || "",
                    age: formDataObject.age || "",
                    occupation: formDataObject.occupation || "",
                    income: formDataObject.income || "",
                    goalIncome: formDataObject.goal_income || "",
                    reason: formDataObject.reason || "",
                    request: formDataObject.request || "",
                    phone: formDataObject.phone || "",
                    contact: formDataObject.contact || "",
                    userid: tgUserId || "unknown_user",
                    timestamp: now.toISOString()
                };

                console.log("Sending to Sheety:", payload);

                fetch(SHEETY_URL, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": SHEETY_AUTH
                    },
                    body: JSON.stringify({ lead: payload })
                })
                .then(async (r) => {
                    const text = await r.text();
                    console.log("Sheety response status:", r.status, r.statusText);
                    console.log("Sheety raw response:", text);
                    try { console.log("Sheety parsed JSON:", JSON.parse(text)); } catch {}
                })
                .catch(err => console.error("Error sending to Sheety:", err));
            };
            
            const lessons = [
                {
                    title: "УРОК #1 — «Быстрый старт в&nbsp;маркетинге»",
                    content: ["Что такое маркетинг. Где здесь деньги?", "Кто такой маркетолог и&nbsp;почему в&nbsp;2025 году все маркетологи будут с&nbsp;деньгами?", "Реальные примеры того, как с&nbsp;нуля можно выйти на&nbsp;150.000+ рублей", "Кто я&nbsp;такой и&nbsp;мои проекты, где я&nbsp;работаю маркетологом"],
                    videoIframe: `<div class="video-container"><iframe src="https://vkvideo.ru/video_ext.php?oid=-225480090&id=456239022&hd=2&autoplay=1" title="УРОК #1 — «Быстрый старт в маркетинге»" allow="autoplay; encrypted-media; fullscreen; picture-in-picture; screen-wake-lock;" frameborder="0" allowfullscreen></iframe></div>`,
                },
                {
                    title: "УРОК #2 — «Где точно платят сотни тысяч в&nbsp;маркетинге?»",
                    content: ["Ты&nbsp;узнаешь про 4&nbsp;лучших направления в&nbsp;маркетинге и&nbsp;сдашь домашку с&nbsp;проверкой"],
                    homework: [
                        { bold: "Выбрать одно из&nbsp;направлений:", regular: "одна услуга, связка услуг, продюсирование, комплексный маркетинг" },
                        { bold: "Кратко описать,", regular: "как ты&nbsp;его понял и&nbsp;что будешь предлагать клиентам" },
                        { bold: "Описать,", regular: "почему ты&nbsp;выбрал именно его, что в&nbsp;нем понравилось" },
                        { bold: "Написать свои вопросы", regular: "в&nbsp;развернутом формате" }
                    ],
                    videoIframe: `<div class="video-container"><iframe src="https://vkvideo.ru/video_ext.php?oid=-225480090&id=456239023&hd=2&autoplay=1" title="УРОК #2 — «Где точно платят сотни тысяч в маркетинге?»" allow="autoplay; encrypted-media; fullscreen; picture-in-picture; screen-wake-lock;" frameborder="0" allowfullscreen></iframe></div>`,
                },
                {
                    title: "УРОК #3 — Вот твой ПЛАН действий для выхода на&nbsp;150.000 рублей на&nbsp;маркетинге",
                    content: ["Разложил по&nbsp;шагам все, что делал&nbsp;Я, когда только начинал свой путь, чтобы&nbsp;уже через год зарабатывать 400.000&nbsp;рублей, а&nbsp;еще через полгода 1&nbsp;млн рублей на&nbsp;своих услугах. Тебе лишь останется применить это у&nbsp;себя."],
                    videoIframe: `<div class="video-container"><iframe src="https://vkvideo.ru/video_ext.php?oid=-225480090&id=456239024&hd=2&autoplay=1" title="УРОК #3 — ПЛАН действий для выхода на 150.000 рублей" allow="autoplay; encrypted-media; fullscreen; picture-in-picture; screen-wake-lock;" frameborder="0" allowfullscreen></iframe></div>`,
                }
            ];
            
            const progressKey = 'egregorSchoolLessonIndex';
            const lessonTitleElement = document.getElementById('lesson-title');
            const lessonContentContainer = document.getElementById('lesson-content-container');
            const lessonVideoContainer = document.getElementById('lesson-video-container');
            const homeworkBlock = document.getElementById('homework-block');
            const homeworkList = document.getElementById('homework-list');
            const navButtonsContainerMain = document.getElementById('nav-buttons-container-main');
            const navButtonsContainerSecondary = document.getElementById('nav-buttons-container-secondary');
            const progressBar = document.getElementById('progress-bar');
            const lesson3ExtraContent = document.getElementById('lesson-3-extra-content');
            
            const questionPlaceholder = document.getElementById('question-placeholder');

            const questionBlockHTML = `
                <div class="bg-white text-neutral-900 p-6 rounded-3xl shadow-lg text-center">
                    <a href="https://t.me/shilovgreg" target="_blank" class="inline-block bg-neutral-800 text-white font-semibold py-3 px-10 rounded-full shadow-lg transition-all duration-300 hover:scale-105 hover:bg-neutral-700">
                        Задать вопрос
                    </a>
                    <p class="text-sm text-neutral-500 mt-4">Если у&nbsp;вас что-то не&nbsp;получилось или возникли вопросы, напишите нам.</p>
                </div>
            `;
            questionPlaceholder.innerHTML = questionBlockHTML;

            let currentLessonIndex = parseInt(localStorage.getItem(progressKey)) || 0;

            const renderLesson = (index) => {
                if (index < 0 || index >= lessons.length) return;
                
                const lesson = lessons[index];
                lessonTitleElement.innerHTML = lesson.title;
                lessonVideoContainer.innerHTML = lesson.videoIframe.replace(/(src="[^"]+)/, `$1&t=${new Date().getTime()}`);

                if (index === 2) {
                    lessonContentContainer.innerHTML = `<blockquote class="bg-neutral-700/50 border-l-4 border-l-[#5FEAFF] text-gray-300 italic p-4 rounded-r-lg"><p>${lesson.content[0]}</p></blockquote>`;
                } else {
                    const listHtml = (lesson.content || []).map(item => `<li>${item}</li>`).join('');
                    lessonContentContainer.innerHTML = `<div class="border-t border-b border-gray-700 py-4 mt-4"><ul class="styled-list space-y-4">${listHtml}</ul></div>`;
                }
                
                if (index === 1 && lesson.homework) {
                    homeworkList.innerHTML = lesson.homework.map(it => `<li><span class="text-gray-200 font-semibold">${it.bold}</span> ${it.regular}</li>`).join('');
                    homeworkBlock.classList.remove('hidden');
                } else {
                    homeworkBlock.classList.add('hidden');
                }

                lesson3ExtraContent.classList.toggle('hidden', index !== 2);

                const totalSteps = lessons.length + 1;
                const progress = ((index + 1) / totalSteps) * 100;
                progressBar.classList.remove('progress-bar-animated');
                void progressBar.offsetWidth;
                progressBar.style.width = `${progress}%`;
                progressBar.classList.add('progress-bar-animated');

                navButtonsContainerMain.innerHTML = '';
                navButtonsContainerSecondary.innerHTML = '';
                navButtonsContainerMain.classList.add('hidden');
                navButtonsContainerSecondary.classList.add('hidden');

                if (index === 1) {
                    renderNavigation(index, navButtonsContainerSecondary);
                    navButtonsContainerSecondary.classList.remove('hidden');
                } else {
                    renderNavigation(index, navButtonsContainerMain);
                    navButtonsContainerMain.classList.remove('hidden');
                }

                window.scrollTo(0, 0);
            };

            const renderNavigation = (index, container) => {
                let buttonsHtml = '';
                if (index > 0) {
                    buttonsHtml += `
                        <button id="prev-lesson-button" aria-label="Предыдущий урок"
                            class="bg-gray-700 text-white font-semibold w-12 h-12 rounded-full shadow-lg transition-all duration-300 hover:scale-105 flex items-center justify-center text-shadow flex-shrink-0">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"/>
                            </svg>
                        </button>`;
                }

                if (index === 2) {
                    buttonsHtml += `
                        <div class="flex-grow">
                            <button class="analytics-cta w-full bg-gradient-to-br from-[#5FEAFF] to-[#4C87FF] text-white font-semibold py-3 px-6 rounded-full shadow-xl transition-all duration-300 hover:scale-105 flex items-center justify-center text-shadow">
                                <span class="text-center">Попасть на&nbsp;разборы</span>
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ml-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"/>
                                </svg>
                            </button>
                        </div>`;
                } else if (index < lessons.length - 1) {
                    buttonsHtml += `
                        <button id="next-lesson-button"
                            class="bg-gradient-to-br from-[#5FEAFF] to-[#4C87FF] text-white font-semibold py-3 px-8 rounded-full shadow-xl transition-all duration-300 hover:scale-105 flex items-center text-shadow flex-grow justify-center">
                            <span>Следующий урок</span>
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ml-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"/>
                            </svg>
                        </button>`;
                }

                let finalHtml = `<div class="flex w-full items-center space-x-4">${buttonsHtml}</div>`;

                if (index === 2) {
                    finalHtml += `
                        <p class="text-center text-xs text-gray-500 mt-4">
                            Нажимая на&nbsp;кнопку «Попасть на разборы» вы&nbsp;соглашаетесь с&nbsp;<a href="https://www.gregedu.ru/polkon" target="_blank" class="underline hover:text-gray-300 transition-colors">Политикой конфиденциальности</a>&nbsp;и&nbsp;даёте&nbsp;<a href="https://www.gregedu.ru/soglasie" target="_blank" class="underline hover:text-gray-300 transition-colors">согласие на&nbsp;обработку персональных данных</a>.
                        </p>`;
                }
                
                container.innerHTML = finalHtml;
            };

            // --- DELEGATED EVENT LISTENER ---
            document.body.addEventListener('click', (e) => {
                const button = e.target.closest('button');
                if (!button) return;

                if (button.classList.contains('analytics-cta')) {
                    openLeadForm();
                    return;
                }

                switch (button.id) {
                    case 'prev-lesson-button':
                        if (currentLessonIndex > 0) {
                            currentLessonIndex--;
                            localStorage.setItem(progressKey, currentLessonIndex);
                            renderLesson(currentLessonIndex);
                        }
                        break;
                    case 'next-lesson-button':
                        if (currentLessonIndex < lessons.length - 1) {
                            currentLessonIndex++;
                            localStorage.setItem(progressKey, currentLessonIndex);
                            renderLesson(currentLessonIndex);
                        }
                        break;
                }
            });
            
            // --- LEAD FORM LOGIC ---
            const leadFormModal    = document.getElementById('lead-form-modal');
            const leadFormContent = document.getElementById('lead-form-content');
            const closeFormButton = document.getElementById('close-form-button');
            const leadForm         = document.getElementById('lead-form');
            const thankYouScreen  = document.getElementById('form-thank-you');
            const progressBarForm = document.getElementById('lead-form-progress-bar');

            let currentStep = 0;
            let answers = {};
            let phoneInputInstance;

            const formSteps = [
                { question: "Как тебя зовут?", type: "text", name: "name", required: true },
                { question: "Сколько тебе лет?", type: "number", name: "age", required: true },
                { question: "Чем ты занимаешься сейчас?", type: "radio", name: "occupation",
                    options: ["Фрилансер","Работаю в найме","Действующий маркетолог","Не работаю","Другая сфера"], required: true },
                { question: "Твой уровень дохода сейчас", type: "text", name: "income", required: true },
                { question: "Сколько хочешь зарабатывать через 8 недель?", type: "text", name: "goal_income", required: true },
                { question: "Почему самостоятельно не получается дойти до желаемого дохода?", type: "textarea", name: "reason", required: true },
                { question: "Какой твой основной запрос сейчас?", type: "textarea", name: "request", required: true },
                { question: "Твой номер телефона для связи", type: "tel", name: "phone", required: true },
                { question: "Оставь свой Telegram или номер, к которому привязан WhatsApp", type: "text", name: "contact", required: true },
            ];

            const openLeadForm = () => {
                answers = {};
                leadFormModal.classList.remove('hidden');
                setTimeout(() => {
                    leadFormContent.classList.add('scale-100','opacity-100');
                    leadFormContent.classList.remove('scale-95','opacity-0');
                }, 50);
                renderFormStep(0);
            };

            const closeLeadForm = () => {
                leadFormContent.classList.remove('scale-100','opacity-100');
                leadFormContent.classList.add('scale-95','opacity-0');
                setTimeout(() => {
                    leadFormModal.classList.add('hidden');
                    leadForm.classList.remove('hidden');
                    thankYouScreen.classList.add('hidden');
                }, 300);
            };

            closeFormButton.addEventListener('click', closeLeadForm);

            const saveStep = () => {
                const step = formSteps[currentStep];
                if (step.type === 'radio') {
                    const checked = document.querySelector(`input[name="${step.name}"]:checked`);
                    if (checked) answers[step.name] = checked.value;
                    const other = document.querySelector('input[name="occupation_other"]');
                    if (other && !other.classList.contains('hidden') && other.value.trim()) {
                        answers['occupation_other'] = other.value.trim();
                    } else {
                        delete answers['occupation_other'];
                    }
                } else if (step.type === 'tel') {
                    if (phoneInputInstance) {
                        answers[step.name] = phoneInputInstance.getNumber();
                    }
                }
                else {
                    const el = document.querySelector(`[name="${step.name}"]`);
                    if (el) answers[step.name] = el.value.trim();
                }
            };

            const renderFormStep = (stepIndex) => {
                currentStep = stepIndex;
                const step = formSteps[stepIndex];
                let html = `<div class="form-step active">
                    <label class="block text-white text-xl font-semibold mb-6 text-center">${step.question}</label>`;

                if (step.type === 'text' || step.type === 'number' || step.type === 'tel') {
                    html += `<input type="${step.type}" name="${step.name}" value="${answers[step.name] || ''}"
                                class="w-full bg-neutral-800 border border-gray-700 rounded-lg p-3 text-white focus:ring-2 focus:ring-sky-500 focus:outline-none"
                                ${step.required ? 'required' : ''}>`;
                } else if (step.type === 'textarea') {
                    html += `<textarea name="${step.name}" rows="4"
                                class="w-full bg-neutral-800 border border-gray-700 rounded-lg p-3 text-white focus:ring-2 focus:ring-sky-500 focus:outline-none"
                                ${step.required ? 'required' : ''}>${answers[step.name] || ''}</textarea>`;
                } else if (step.type === 'radio') {
                    html += `<div class="space-y-3 text-left">`;
                    (step.options || []).forEach(opt => {
                        const checked = answers[step.name] === opt ? 'checked' : '';
                        html += `<label class="flex items-center p-3 bg-neutral-800 rounded-lg cursor-pointer hover:bg-neutral-700 transition-colors">
                                    <input type="radio" name="${step.name}" value="${opt}" class="mr-3" ${checked} ${step.required ? 'required' : ''}>
                                    <span>${opt}</span>
                                    </label>`;
                    });
                    const showOther = answers[step.name] === 'Другая сфера';
                    html += `<input type="text" name="occupation_other" placeholder="Напишите свой вариант"
                                value="${showOther ? (answers['occupation_other'] || '') : ''}"
                                class="w-full bg-neutral-800 border border-gray-700 rounded-lg p-3 text-white focus:ring-2 focus:ring-sky-500 focus:outline-none mt-3 ${showOther ? '' : 'hidden'}">`;
                    html += `</div>`;
                }

                html += `<div class="flex justify-between mt-8">`;
                if (stepIndex > 0) {
                    html += `<button type="button" id="form-back-btn" class="bg-gray-700 text-white font-semibold py-3 px-8 rounded-full shadow-lg transition-colors duration-300 hover:bg-gray-600">Назад</button>`;
                } else {
                    html += `<div></div>`;
                }
                if (stepIndex < formSteps.length - 1) {
                    html += `<button type="button" id="form-next-btn" class="bg-gradient-to-br from-[#5FEAFF] to-[#4C87FF] text-white font-semibold py-3 px-8 rounded-full shadow-xl transition-all duration-300 hover:scale-105">Далее</button>`;
                } else {
                    html += `<button type="submit" class="bg-gradient-to-br from-[#5FEAFF] to-[#4C87FF] text-white font-semibold py-3 px-8 rounded-full shadow-xl transition-all duration-300 hover:scale-105">Отправить</button>`;
                }
                html += `</div></div>`;

                leadForm.innerHTML = html;
                progressBarForm.style.width = `${((stepIndex + 1) / formSteps.length) * 100}%`;

                if (step.type === 'tel') {
                    const phoneInput = document.querySelector('input[name="phone"]');
                    phoneInputInstance = window.intlTelInput(phoneInput, {
                        initialCountry: "ru",
                        utilsScript: "https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/js/utils.js",
                    });
                }

                document.getElementById('form-next-btn')?.addEventListener('click', nextStep);
                document.getElementById('form-back-btn')?.addEventListener('click', prevStep);
                document.querySelectorAll('input[name="occupation"]').forEach(radio => {
                    radio.addEventListener('change', (e) => {
                        const otherInput = document.querySelector('input[name="occupation_other"]');
                        otherInput.classList.toggle('hidden', e.target.value !== 'Другая сфера');
                    });
                });
            };
            
            const nextStep = () => {
                const currentInputs = leadForm.querySelectorAll(`[name="${formSteps[currentStep].name}"]`);
                let isValid = true;
                currentInputs.forEach(input => {
                    if (input.required && !input.value && input.type !== 'radio') isValid = false;
                    if (input.type === 'radio' && input.required) {
                        if (!document.querySelector(`input[name="${formSteps[currentStep].name}"]:checked`)) {
                            isValid = false;
                        }
                    }
                });

                if (isValid) {
                    saveStep();
                    if (currentStep < formSteps.length - 1) {
                        renderFormStep(currentStep + 1);
                    }
                }
            };
            
            const prevStep = () => {
                saveStep();
                if (currentStep > 0) renderFormStep(currentStep - 1);
            };

            leadForm.addEventListener('submit', (e) => {
                e.preventDefault();
                saveStep();
                const payload = { ...answers };
                if (payload.occupation === 'Другая сфера' && payload.occupation_other) {
                    payload.occupation = payload.occupation_other;
                }
                delete payload.occupation_other;

                submitFormData(payload);

                leadForm.classList.add('hidden');
                thankYouScreen.classList.remove('hidden');
                setTimeout(closeLeadForm, 2500);
            });

            leadForm.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    if (currentStep < formSteps.length - 1) {
                        nextStep();
                    } else {
                        leadForm.dispatchEvent(new Event('submit', { cancelable: true }));
                    }
                }
            });

            // старт
            renderLesson(currentLessonIndex);
        });
    </script>
</body>
</html>
